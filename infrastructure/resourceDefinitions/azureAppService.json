{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "variables": {},
  "parameters": {
    "appName": {"type": "string", "metadata": {"description": "Application name"}},
    "environment": {"type": "string", "metadata": {"description": "Azure Deployment Environment"}},
    "stage": {"type": "string", "metadata": {"description": "Azure Deployment Stage"}},
    "location": {"type": "string", "metadata": {"description": "Azure Deployment Location"}, "defaultValue": "westeurope"},
    "servicePlanSku": {"type": "string", "metadata": {"description": "SKU For the Service Plan"}, "defaultValue": "Free F1"},
    "acrEnvironment": {"type": "string", "metadata": {"description": "Environment where Azure Container Registry is Deployed"}},
    "acrStage":       {"type": "string", "metadata": {"description": "Stage where Azure Container Registry is Deployed"}}
  },
  "resources": [
  {
    "name": "[concat(parameters('environment'), '-', parameters('stage'), '-', parameters('appName'), '-serviceplan')]",
    "type": "Microsoft.Web/serverfarms",
    "sku": {
      "Tier": "[first(skip(split(parameters('servicePlanSku'), ' '), 1))]",
      "Name": "[first(split(parameters('servicePlanSku'), ' '))]"
    },
    "kind": "linux",
    "apiVersion": "2020-12-01",
    "location": "[parameters('location')]",
    "properties": {
      "name": "[concat(parameters('environment'), '-', parameters('stage'), '-', parameters('appName'), '-serviceplan')]",
      "workerSizeId": "0",
      "reserved": false,
      "numberOfWorkers": "1",
      "hostingEnvironment": ""
    },
    "tags": {
      "service": "appserviceplan",
      "application": "[parameters('appName')]",
      "environment": "[parameters('environment')]",
      "stage": "[parameters('stage')]",
      "location": "[parameters('location')]",
      "createdBy": "Azure Pipeline via ARM"
    }
  },
  {
    "type": "Microsoft.Web/sites",
    "name": "[parameters('appName')]",
    "apiVersion": "2020-12-01",
    "location": "[parameters('location')]",
    "tags": {
      "service": "appservice",
      "application": "[parameters('appName')]",
      "environment": "[parameters('environment')]",
      "stage": "[parameters('stage')]",
      "location": "[parameters('location')]",
      "createdBy": "Azure Pipeline via ARM"
    },
    "properties": {
      "name": "[parameters('appName')]",
      "siteConfig": {
        "appSettings": [
          {
            "name": "DOCKER_REGISTRY_SERVER_URL",
            "value": "[concat('https://', reference(resourceId(concat(parameters('acrEnvironment'), parameters('acrStage'), '-rg'), 'Microsoft.ContainerRegistry/registries', concat(parameters('acrEnvironment'), parameters('acrStage'), 'acr'), '2019-06-01')).loginServer)]"
          },
          {
            "name": "DOCKER_REGISTRY_SERVER_USERNAME",
            "value": "[listCredentials(resourceId(concat(parameters('acrEnvironment'), parameters('acrStage'), '-rg'), 'Microsoft.ContainerRegistry/registries', concat(parameters('acrEnvironment'), parameters('acrStage'), 'acr'), '2019-06-01'), '2017-10-01').username]"
          },
          {
            "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
            "value": "[listCredentials(resourceId(concat(parameters('acrEnvironment'), parameters('acrStage'), '-rg'), 'Microsoft.ContainerRegistry/registries', concat(parameters('acrEnvironment'), parameters('acrStage'), 'acr'), '2019-06-01'), '2017-10-01').passwords[0].value]"
          },
          {
            "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
            "value": "false"
          }
        ],
        "appCommandLine": "[concat('./', parameters('appName'))]",
        "linuxFxVersion": "[concat('DOCKER|', reference(resourceId(concat(parameters('acrEnvironment'), parameters('acrStage'), '-rg'), 'Microsoft.ContainerRegistry/registries', concat(parameters('acrEnvironment'), parameters('acrStage'), 'acr'), '2019-06-01')).loginServer, '/', parameters('appName'))]"
      },
      "serverFarmId": "[concat(parameters('environment'), '-', parameters('stage'), '-', parameters('appName'), '-serviceplan')]",
      "hostingEnvironment": "",
      "tags": {
        "service": "application",
        "application": "[parameters('appName')]",
        "environment": "[parameters('environment')]",
        "stage": "[parameters('stage')]",
        "location": "[parameters('location')]",
        "createdBy": "Azure Pipeline via ARM"
      }
    },
    "dependsOn": [
      "[concat('Microsoft.Web/serverfarms/', concat(parameters('environment'), '-', parameters('stage'), '-', parameters('appName'), '-serviceplan'))]"
    ]
  }
  ]
}