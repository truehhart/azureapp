trigger:
  branches:
    include: ['feature/*']
  paths:
    include: ['src/azureapp/']

name: 'prepare-management-infrastructure'
variables:
  environment: 'management'
  stage: 'truehhart'
  subscriptionName: 'main'
  appName: 'azureapp'
  location: 'westeurope'

stages:
- stage: 'prepare_infrastructure'
  jobs: 
  - job: 'deploy_azure_resources'
    pool: localhost
    steps:
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: '[Azure] Deploy ResourceGroup'
        inputs:
          deploymentScope: 'Subscription'
          templateLocation: 'Linked artifact'
          csmFile:  '$(Build.Repository.LocalPath)/infrastructure/resourceDefinitions/azureResourceGroup.json'
          ConnectedServiceName: '$(subscriptionName)-sc'
          location: '$(location)'
          overrideParameters: '-environment "$(environment)" -stage "$(stage)" -location $(location)'

      - task: AzureResourceManagerTemplateDeployment@3
        displayName: '[Azure] Deploy ContainerRegistry'
        inputs:
          deploymentScope: 'ResourceGroup'
          templateLocation: 'Linked artifact'
          csmFile:  '$(Build.Repository.LocalPath)/infrastructure/resourceDefinitions/azureResourceGroup.json'
          ConnectedServiceName: '$(subscriptionName)-sc'
          resourceGroupName: '$(environment)-$(stage)-rg'
          location: '$(location)'